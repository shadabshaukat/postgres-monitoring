<!DOCTYPE html>
<html>
<head>
    <title>PostgreSQL Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        .metric-card { border: 1px solid #ddd; padding: 15px; margin: 10px; border-radius: 5px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 8px; border: 1px solid #ddd; text-align: left; }
    </style>
</head>
<body>
    <h1>PostgreSQL Monitoring</h1>
    
    <div>
        <select id="dbSelector" onchange="loadAllData()">
            <option value="">Select Database</option>
            {% for db in databases %}
            <option value="{{ db }}">{{ db }}</option>
            {% endfor %}
        </select>
    </div>

    <div id="metrics"></div>

    <script>
        const endpoints = [
            {name: 'Top Queries', url: '/query/top_queries'},
            {name: 'Index Usage', url: '/query/index_usage'},
            {name: 'Locks', url: '/query/locks'},
            {name: 'Cache Hit', url: '/query/cache_hit'},
            {name: 'Replication', url: '/query/replication'},
            {name: 'Connections', url: '/query/connections'},
            {name: 'Dead Tuples', url: '/query/dead_tuples'},
            {name: 'WAL', url: '/query/wal'},
            {name: 'BG Writer', url: '/query/bgwriter'},
            {name: 'Table Sizes', url: '/query/table_sizes'}
        ];

        async function fetchData(endpoint) {
            const db = document.getElementById('dbSelector').value;
            if (!db) return;

            try {
                const params = new URLSearchParams({ db_name: db });
                const response = await axios.get(`${endpoint.url}?${params}`);
                renderMetric(endpoint.name, response.data);
            } catch (error) {
                console.error(`Error fetching ${endpoint.name}:`, error);
            }
        }

        function renderMetric(title, data) {
            let html = `<div class="metric-card"><h3>${title}</h3><table>`;
            if (data.length > 0) {
                html += '<tr>' + Object.keys(data[0]).map(k => `<th>${k}</th>`).join('') + '</tr>';
                html += data.map(row =>
                    '<tr>' + Object.values(row).map(v => `<td>${v}</td>`).join('') + '</tr>'
                ).join('');
            } else {
                html += '<tr><td colspan="3">No data available</td></tr>';
            }
            html += '</table></div>';
            document.getElementById('metrics').insertAdjacentHTML('beforeend', html);
        }

        async function loadAllData() {
            document.getElementById('metrics').innerHTML = '';
            for (const endpoint of endpoints) {
                await fetchData(endpoint);
            }
        }
    </script>
</body>
</html>
